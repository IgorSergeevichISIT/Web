{"version":3,"sources":["../src/index.ts"],"sourcesContent":["// Credits: https://github.com/adobe/react-spectrum/blob/main/packages/@react-aria/overlays/src/ariaHideOutside.ts\nimport { raf } from \"@zag-js/dom-query\"\n\nconst refCountMap = new WeakMap<Element, number>()\nconst observerStack: any[] = []\n\nexport interface AriaHiddenOptions {\n  rootEl?: HTMLElement\n  defer?: boolean\n}\n\ntype MaybeElement = HTMLElement | null\ntype Targets = Array<MaybeElement>\ntype TargetsOrFn = Targets | (() => Targets)\n\nfunction ariaHiddenImpl(targets: Targets, options: AriaHiddenOptions = {}) {\n  const { rootEl } = options\n\n  const exclude = targets.filter(Boolean) as HTMLElement[]\n  if (exclude.length === 0) return\n\n  const doc = exclude[0].ownerDocument || document\n  const win = doc.defaultView ?? window\n\n  const visibleNodes = new Set<Element>(exclude)\n  const hiddenNodes = new Set<Element>()\n\n  const root = rootEl ?? doc.body\n\n  let walk = (root: Element) => {\n    // Keep live announcer and top layer elements (e.g. toasts) visible.\n    for (let element of root.querySelectorAll(\"[data-live-announcer], [data-zag-top-layer]\")) {\n      visibleNodes.add(element)\n    }\n\n    let acceptNode = (node: Element) => {\n      // Skip this node and its children if it is one of the target nodes, or a live announcer.\n      // Also skip children of already hidden nodes, as aria-hidden is recursive. An exception is\n      // made for elements with role=\"row\" since VoiceOver on iOS has issues hiding elements with role=\"row\".\n      // For that case we want to hide the cells inside as well (https://bugs.webkit.org/show_bug.cgi?id=222623).\n      if (\n        visibleNodes.has(node) ||\n        (hiddenNodes.has(node.parentElement!) && node.parentElement!.getAttribute(\"role\") !== \"row\")\n      ) {\n        return NodeFilter.FILTER_REJECT\n      }\n\n      // Skip this node but continue to children if one of the targets is inside the node.\n      for (let target of visibleNodes) {\n        if (node.contains(target)) {\n          return NodeFilter.FILTER_SKIP\n        }\n      }\n\n      return NodeFilter.FILTER_ACCEPT\n    }\n\n    let walker = doc.createTreeWalker(root, NodeFilter.SHOW_ELEMENT, { acceptNode })\n\n    // TreeWalker does not include the root.\n    let acceptRoot = acceptNode(root)\n    if (acceptRoot === NodeFilter.FILTER_ACCEPT) {\n      hide(root)\n    }\n\n    if (acceptRoot !== NodeFilter.FILTER_REJECT) {\n      let node = walker.nextNode() as Element\n      while (node != null) {\n        hide(node)\n        node = walker.nextNode() as Element\n      }\n    }\n  }\n\n  let hide = (node: Element) => {\n    let refCount = refCountMap.get(node) ?? 0\n\n    // If already aria-hidden, and the ref count is zero, then this element\n    // was already hidden and there's nothing for us to do.\n    if (node.getAttribute(\"aria-hidden\") === \"true\" && refCount === 0) {\n      return\n    }\n\n    if (refCount === 0) {\n      node.setAttribute(\"aria-hidden\", \"true\")\n    }\n\n    hiddenNodes.add(node)\n    refCountMap.set(node, refCount + 1)\n  }\n\n  if (observerStack.length) {\n    observerStack[observerStack.length - 1].disconnect()\n  }\n\n  walk(root)\n\n  const observer = new win.MutationObserver((changes) => {\n    for (let change of changes) {\n      if (change.type !== \"childList\" || change.addedNodes.length === 0) {\n        continue\n      }\n\n      // If the parent element of the added nodes is not within one of the targets,\n      // and not already inside a hidden node, hide all of the new children.\n      if (![...visibleNodes, ...hiddenNodes].some((node) => node.contains(change.target))) {\n        for (let node of change.removedNodes) {\n          if (node instanceof win.Element) {\n            visibleNodes.delete(node)\n            hiddenNodes.delete(node)\n          }\n        }\n\n        for (let node of change.addedNodes) {\n          if (\n            (node instanceof win.HTMLElement || node instanceof win.SVGElement) &&\n            (node.dataset.liveAnnouncer === \"true\" || node.dataset.zagTopLayer === \"true\")\n          ) {\n            visibleNodes.add(node)\n          } else if (node instanceof win.Element) {\n            walk(node)\n          }\n        }\n      }\n    }\n  })\n\n  observer.observe(root, { childList: true, subtree: true })\n\n  let observerWrapper = {\n    observe() {\n      observer.observe(root, { childList: true, subtree: true })\n    },\n    disconnect() {\n      observer.disconnect()\n    },\n  }\n\n  observerStack.push(observerWrapper)\n\n  return () => {\n    observer.disconnect()\n\n    for (let node of hiddenNodes) {\n      let count = refCountMap.get(node)\n      if (count === 1) {\n        node.removeAttribute(\"aria-hidden\")\n        refCountMap.delete(node)\n      } else {\n        refCountMap.set(node, count! - 1)\n      }\n    }\n\n    // Remove this observer from the stack, and start the previous one.\n    if (observerWrapper === observerStack[observerStack.length - 1]) {\n      observerStack.pop()\n      if (observerStack.length) {\n        observerStack[observerStack.length - 1].observe()\n      }\n    } else {\n      observerStack.splice(observerStack.indexOf(observerWrapper), 1)\n    }\n  }\n}\n\nexport function ariaHidden(targetsOrFn: TargetsOrFn, options: AriaHiddenOptions = {}) {\n  const { defer } = options\n  const func = defer ? raf : (v: any) => v()\n  const cleanups: (VoidFunction | undefined)[] = []\n  cleanups.push(\n    func(() => {\n      const targets = typeof targetsOrFn === \"function\" ? targetsOrFn() : targetsOrFn\n      cleanups.push(ariaHiddenImpl(targets, options))\n    }),\n  )\n  return () => {\n    cleanups.forEach((fn) => fn?.())\n  }\n}\n"],"mappings":"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","names":["root"]}