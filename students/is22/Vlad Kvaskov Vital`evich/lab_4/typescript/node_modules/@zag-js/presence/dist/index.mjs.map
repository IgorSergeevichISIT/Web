{"version":3,"sources":["../src/presence.connect.ts","../src/presence.machine.ts","../src/presence.props.ts"],"sourcesContent":["import type { NormalizeProps, PropTypes } from \"@zag-js/types\"\nimport type { MachineApi, Send, State } from \"./presence.types\"\n\nexport function connect<T extends PropTypes>(state: State, send: Send, _normalize: NormalizeProps<T>): MachineApi {\n  const present = state.matches(\"mounted\", \"unmountSuspended\")\n  return {\n    skip: !state.context.initial && present,\n    present,\n    setNode(node) {\n      if (!node) return\n      send({ type: \"NODE.SET\", node })\n    },\n    unmount() {\n      send({ type: \"UNMOUNT\" })\n    },\n  }\n}\n","import { createMachine, ref } from \"@zag-js/core\"\nimport type { MachineContext, MachineState, UserDefinedContext } from \"./presence.types\"\n\nfunction getAnimationName(styles?: CSSStyleDeclaration | null) {\n  return styles?.animationName || \"none\"\n}\n\nexport function machine(ctx: Partial<UserDefinedContext>) {\n  return createMachine<MachineContext, MachineState>(\n    {\n      initial: ctx.present ? \"mounted\" : \"unmounted\",\n\n      context: {\n        node: null,\n        styles: null,\n        unmountAnimationName: null,\n        prevAnimationName: null,\n        present: false,\n        initial: false,\n        ...ctx,\n      },\n\n      exit: [\"clearInitial\"],\n\n      watch: {\n        present: [\"setInitial\", \"syncPresence\"],\n      },\n\n      on: {\n        \"NODE.SET\": {\n          actions: [\"setNode\", \"setStyles\"],\n        },\n      },\n\n      states: {\n        mounted: {\n          on: {\n            UNMOUNT: {\n              target: \"unmounted\",\n              actions: [\"invokeOnExitComplete\"],\n            },\n            \"UNMOUNT.SUSPEND\": \"unmountSuspended\",\n          },\n        },\n        unmountSuspended: {\n          activities: [\"trackAnimationEvents\"],\n          on: {\n            MOUNT: {\n              target: \"mounted\",\n              actions: [\"setPrevAnimationName\"],\n            },\n            \"ANIMATION.END\": {\n              target: \"unmounted\",\n              actions: [\"invokeOnExitComplete\"],\n            },\n            UNMOUNT: {\n              target: \"unmounted\",\n              actions: [\"invokeOnExitComplete\"],\n            },\n          },\n        },\n        unmounted: {\n          entry: [\"clearPrevAnimationName\"],\n          on: {\n            MOUNT: {\n              target: \"mounted\",\n              actions: [\"setPrevAnimationName\"],\n            },\n          },\n        },\n      },\n    },\n    {\n      actions: {\n        setInitial(ctx) {\n          ctx.initial = true\n        },\n        clearInitial(ctx) {\n          ctx.initial = false\n        },\n        invokeOnExitComplete(ctx) {\n          ctx.onExitComplete?.()\n        },\n        setNode(ctx, evt) {\n          ctx.node = ref(evt.node)\n        },\n        setStyles(ctx, evt) {\n          const win = evt.node.ownerDocument.defaultView || window\n          ctx.styles = ref(win.getComputedStyle(evt.node))\n        },\n        syncPresence(ctx, _evt, { send }) {\n          if (ctx.present) {\n            send({ type: \"MOUNT\", src: \"presence.changed\" })\n            return\n          }\n\n          const animationName = getAnimationName(ctx.styles)\n          const exec = ctx.immediate ? queueMicrotask : requestAnimationFrame\n\n          exec(() => {\n            ctx.unmountAnimationName = animationName\n            if (\n              animationName === \"none\" ||\n              animationName === ctx.prevAnimationName ||\n              ctx.styles?.display === \"none\" ||\n              ctx.styles?.animationDuration === \"0s\"\n            ) {\n              send({ type: \"UNMOUNT\", src: \"presence.changed\" })\n            } else {\n              send({ type: \"UNMOUNT.SUSPEND\" })\n            }\n          })\n        },\n        setPrevAnimationName(ctx) {\n          const exec = ctx.immediate ? queueMicrotask : requestAnimationFrame\n          exec(() => {\n            ctx.prevAnimationName = getAnimationName(ctx.styles)\n          })\n        },\n        clearPrevAnimationName(ctx) {\n          ctx.prevAnimationName = null\n        },\n      },\n      activities: {\n        trackAnimationEvents(ctx, _evt, { send }) {\n          const node = ctx.node\n          if (!node) return\n\n          const onStart = (event: AnimationEvent) => {\n            if (event.target === node) {\n              ctx.prevAnimationName = getAnimationName(ctx.styles)\n            }\n          }\n\n          const onEnd = (event: AnimationEvent) => {\n            const animationName = getAnimationName(ctx.styles)\n            if (event.target === node && animationName === ctx.unmountAnimationName) {\n              send({ type: \"UNMOUNT\", src: \"animationend\" })\n            }\n          }\n\n          node.addEventListener(\"animationstart\", onStart)\n          node.addEventListener(\"animationcancel\", onEnd)\n          node.addEventListener(\"animationend\", onEnd)\n\n          return () => {\n            node.removeEventListener(\"animationstart\", onStart)\n            node.removeEventListener(\"animationcancel\", onEnd)\n            node.removeEventListener(\"animationend\", onEnd)\n          }\n        },\n      },\n    },\n  )\n}\n","import { createProps } from \"@zag-js/types\"\nimport type { UserDefinedContext } from \"./presence.types\"\n\nexport const props = createProps<UserDefinedContext>()([\"onExitComplete\", \"present\", \"immediate\"])\n"],"mappings":";AAGO,SAAS,QAA6B,OAAc,MAAY,YAA2C;AAChH,QAAM,UAAU,MAAM,QAAQ,WAAW,kBAAkB;AAC3D,SAAO;AAAA,IACL,MAAM,CAAC,MAAM,QAAQ,WAAW;AAAA,IAChC;AAAA,IACA,QAAQ,MAAM;AACZ,UAAI,CAAC,KAAM;AACX,WAAK,EAAE,MAAM,YAAY,KAAK,CAAC;AAAA,IACjC;AAAA,IACA,UAAU;AACR,WAAK,EAAE,MAAM,UAAU,CAAC;AAAA,IAC1B;AAAA,EACF;AACF;;;AChBA,SAAS,eAAe,WAAW;AAGnC,SAAS,iBAAiB,QAAqC;AAC7D,SAAO,QAAQ,iBAAiB;AAClC;AAEO,SAAS,QAAQ,KAAkC;AACxD,SAAO;AAAA,IACL;AAAA,MACE,SAAS,IAAI,UAAU,YAAY;AAAA,MAEnC,SAAS;AAAA,QACP,MAAM;AAAA,QACN,QAAQ;AAAA,QACR,sBAAsB;AAAA,QACtB,mBAAmB;AAAA,QACnB,SAAS;AAAA,QACT,SAAS;AAAA,QACT,GAAG;AAAA,MACL;AAAA,MAEA,MAAM,CAAC,cAAc;AAAA,MAErB,OAAO;AAAA,QACL,SAAS,CAAC,cAAc,cAAc;AAAA,MACxC;AAAA,MAEA,IAAI;AAAA,QACF,YAAY;AAAA,UACV,SAAS,CAAC,WAAW,WAAW;AAAA,QAClC;AAAA,MACF;AAAA,MAEA,QAAQ;AAAA,QACN,SAAS;AAAA,UACP,IAAI;AAAA,YACF,SAAS;AAAA,cACP,QAAQ;AAAA,cACR,SAAS,CAAC,sBAAsB;AAAA,YAClC;AAAA,YACA,mBAAmB;AAAA,UACrB;AAAA,QACF;AAAA,QACA,kBAAkB;AAAA,UAChB,YAAY,CAAC,sBAAsB;AAAA,UACnC,IAAI;AAAA,YACF,OAAO;AAAA,cACL,QAAQ;AAAA,cACR,SAAS,CAAC,sBAAsB;AAAA,YAClC;AAAA,YACA,iBAAiB;AAAA,cACf,QAAQ;AAAA,cACR,SAAS,CAAC,sBAAsB;AAAA,YAClC;AAAA,YACA,SAAS;AAAA,cACP,QAAQ;AAAA,cACR,SAAS,CAAC,sBAAsB;AAAA,YAClC;AAAA,UACF;AAAA,QACF;AAAA,QACA,WAAW;AAAA,UACT,OAAO,CAAC,wBAAwB;AAAA,UAChC,IAAI;AAAA,YACF,OAAO;AAAA,cACL,QAAQ;AAAA,cACR,SAAS,CAAC,sBAAsB;AAAA,YAClC;AAAA,UACF;AAAA,QACF;AAAA,MACF;AAAA,IACF;AAAA,IACA;AAAA,MACE,SAAS;AAAA,QACP,WAAWA,MAAK;AACd,UAAAA,KAAI,UAAU;AAAA,QAChB;AAAA,QACA,aAAaA,MAAK;AAChB,UAAAA,KAAI,UAAU;AAAA,QAChB;AAAA,QACA,qBAAqBA,MAAK;AACxB,UAAAA,KAAI,iBAAiB;AAAA,QACvB;AAAA,QACA,QAAQA,MAAK,KAAK;AAChB,UAAAA,KAAI,OAAO,IAAI,IAAI,IAAI;AAAA,QACzB;AAAA,QACA,UAAUA,MAAK,KAAK;AAClB,gBAAM,MAAM,IAAI,KAAK,cAAc,eAAe;AAClD,UAAAA,KAAI,SAAS,IAAI,IAAI,iBAAiB,IAAI,IAAI,CAAC;AAAA,QACjD;AAAA,QACA,aAAaA,MAAK,MAAM,EAAE,KAAK,GAAG;AAChC,cAAIA,KAAI,SAAS;AACf,iBAAK,EAAE,MAAM,SAAS,KAAK,mBAAmB,CAAC;AAC/C;AAAA,UACF;AAEA,gBAAM,gBAAgB,iBAAiBA,KAAI,MAAM;AACjD,gBAAM,OAAOA,KAAI,YAAY,iBAAiB;AAE9C,eAAK,MAAM;AACT,YAAAA,KAAI,uBAAuB;AAC3B,gBACE,kBAAkB,UAClB,kBAAkBA,KAAI,qBACtBA,KAAI,QAAQ,YAAY,UACxBA,KAAI,QAAQ,sBAAsB,MAClC;AACA,mBAAK,EAAE,MAAM,WAAW,KAAK,mBAAmB,CAAC;AAAA,YACnD,OAAO;AACL,mBAAK,EAAE,MAAM,kBAAkB,CAAC;AAAA,YAClC;AAAA,UACF,CAAC;AAAA,QACH;AAAA,QACA,qBAAqBA,MAAK;AACxB,gBAAM,OAAOA,KAAI,YAAY,iBAAiB;AAC9C,eAAK,MAAM;AACT,YAAAA,KAAI,oBAAoB,iBAAiBA,KAAI,MAAM;AAAA,UACrD,CAAC;AAAA,QACH;AAAA,QACA,uBAAuBA,MAAK;AAC1B,UAAAA,KAAI,oBAAoB;AAAA,QAC1B;AAAA,MACF;AAAA,MACA,YAAY;AAAA,QACV,qBAAqBA,MAAK,MAAM,EAAE,KAAK,GAAG;AACxC,gBAAM,OAAOA,KAAI;AACjB,cAAI,CAAC,KAAM;AAEX,gBAAM,UAAU,CAAC,UAA0B;AACzC,gBAAI,MAAM,WAAW,MAAM;AACzB,cAAAA,KAAI,oBAAoB,iBAAiBA,KAAI,MAAM;AAAA,YACrD;AAAA,UACF;AAEA,gBAAM,QAAQ,CAAC,UAA0B;AACvC,kBAAM,gBAAgB,iBAAiBA,KAAI,MAAM;AACjD,gBAAI,MAAM,WAAW,QAAQ,kBAAkBA,KAAI,sBAAsB;AACvE,mBAAK,EAAE,MAAM,WAAW,KAAK,eAAe,CAAC;AAAA,YAC/C;AAAA,UACF;AAEA,eAAK,iBAAiB,kBAAkB,OAAO;AAC/C,eAAK,iBAAiB,mBAAmB,KAAK;AAC9C,eAAK,iBAAiB,gBAAgB,KAAK;AAE3C,iBAAO,MAAM;AACX,iBAAK,oBAAoB,kBAAkB,OAAO;AAClD,iBAAK,oBAAoB,mBAAmB,KAAK;AACjD,iBAAK,oBAAoB,gBAAgB,KAAK;AAAA,UAChD;AAAA,QACF;AAAA,MACF;AAAA,IACF;AAAA,EACF;AACF;;;AC1JA,SAAS,mBAAmB;AAGrB,IAAM,QAAQ,YAAgC,EAAE,CAAC,kBAAkB,WAAW,WAAW,CAAC;","names":["ctx"]}